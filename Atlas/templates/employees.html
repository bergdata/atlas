{% extends "base.html" %}

{% block title %}Employees - Atlas Config{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-users me-2"></i>Employee Configuration</h2>
        <div>
            <button class="btn btn-primary me-2" onclick="refreshEmployees()">
                <i class="fas fa-sync me-2"></i>Refresh from CRM
            </button>
            <button class="btn btn-success" onclick="exportEmployees()">
                <i class="fas fa-download me-2"></i>Export
            </button>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Manage employee configurations. These employees are assigned to handle specific destinations and automations.
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchInput" placeholder="Search employees...">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="teamFilter">
                <option value="">All Teams</option>
                <option value="none">None</option>
                {% for team_id, team in teams.items() %}
                <option value="{{ team_id }}">{{ team.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="employeesTable">
            <thead class="table-dark">
                <tr>
                    <th class="sortable" data-column="0">
                        ID <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-column="1">
                        Username <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-column="2">
                        Email <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-column="3">
                        Phone Extension <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th class="sortable" data-column="4">
                        Teams <i class="fas fa-sort sort-icon"></i>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for emp_id, emp in employees.items() %}
                <tr>
                    <td>{{ emp_id }}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ emp.username|replace('@riksjatravel.nl', '')|replace('@RIKSJATRAVEL.NL', '')|lower }}"
                               onchange="updateEmployee('{{ emp_id }}', 'username', this.value)">
                    </td>
                    <td>
                        <input type="email" class="form-control form-control-sm"
                               value="{{ emp.email }}"
                               onchange="updateEmployee('{{ emp_id }}', 'email', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ emp.phone_extension }}"
                               onchange="updateEmployee('{{ emp_id }}', 'phone_extension', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ emp.teams|join(', ') }}"
                               onchange="updateEmployee('{{ emp_id }}', 'teams', this.value)">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('{{ emp_id }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <h5>Add New Employee</h5>
        <div class="row">
            <div class="col-md-2">
                <input type="text" class="form-control" id="newEmpId" placeholder="Employee ID">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" id="newEmpUsername" placeholder="Username">
            </div>
            <div class="col-md-3">
                <input type="email" class="form-control" id="newEmpEmail" placeholder="Email">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" id="newEmpPhone" placeholder="Phone Extension">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" id="newEmpTeams" placeholder="Teams (comma separated)">
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary" onclick="addEmployee()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="alert alert-warning mt-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Note:</strong> Changes are saved automatically. The "Refresh from CRM" button will reload employee data from your CRM system.
    </div>
</div>
{% endblock %}

<style>
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
    margin-left: 5px;
    opacity: 0.5;
}

.sort-asc .sort-icon:before {
    content: "\f145"; /* fa-sort-up */
}

.sort-desc .sort-icon:before {
    content: "\f144"; /* fa-sort-down */
}
</style>

{% block scripts %}
<script>
let allEmployees = {{ employees|tojson|safe }};
let teamData = {{ teams|tojson|safe }};
let currentSortColumn = -1;
let currentSortDirection = 'asc';

document.addEventListener('DOMContentLoaded', function() {
    populateTeamFilter();
    setupSearch();
    setupSorting();
});

function populateTeamFilter() {
    // Team filter is now populated statically in the HTML template
    // This function is kept for potential future dynamic updates
}

function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    const teamFilter = document.getElementById('teamFilter');

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedTeam = teamFilter.value;
        const rows = document.querySelectorAll('#employeesTable tbody tr');

        rows.forEach(row => {
            const username = row.cells[1].querySelector('input').value.toLowerCase();
            const email = row.cells[2].querySelector('input').value.toLowerCase();
            const teams = row.cells[4].querySelector('input').value.toLowerCase();

            const matchesSearch = username.includes(searchTerm) || email.includes(searchTerm);

            let matchesTeam = true;
            if (selectedTeam) {
                if (selectedTeam === 'none') {
                    // Show employees with no teams or empty teams
                    matchesTeam = !teams || teams.trim() === '';
                } else {
                    // Show employees that have the selected team ID
                    matchesTeam = teams.includes(selectedTeam.toLowerCase());
                }
            }

            row.style.display = matchesSearch && matchesTeam ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterTable);
    teamFilter.addEventListener('change', filterTable);
}

function setupSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');

    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.getAttribute('data-column'));

            // Toggle sort direction if same column, otherwise set to ascending
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            sortTable(column, currentSortDirection);
            updateSortIndicators();
        });
    });
}

function sortTable(column, direction) {
    const tbody = document.querySelector('#employeesTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;

        if (column === 0) {
            // ID column - treat as string
            aValue = a.cells[column].textContent.trim();
            bValue = b.cells[column].textContent.trim();
        } else if (column === 3) {
            // Phone Extension column - try to parse as number, fallback to string
            aValue = a.cells[column].querySelector('input').value.trim();
            bValue = b.cells[column].querySelector('input').value.trim();

            const aNum = parseInt(aValue) || 0;
            const bNum = parseInt(bValue) || 0;

            if (aNum !== bNum) {
                aValue = aNum;
                bValue = bNum;
            }
        } else {
            // Other columns - get value from input field
            aValue = a.cells[column].querySelector('input').value.trim().toLowerCase();
            bValue = b.cells[column].querySelector('input').value.trim().toLowerCase();
        }

        if (direction === 'asc') {
            return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
        } else {
            return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
        }
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function updateSortIndicators() {
    // Clear all sort indicators
    document.querySelectorAll('.sortable').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });

    // Set indicator for current sort column
    if (currentSortColumn >= 0) {
        const currentHeader = document.querySelector(`[data-column="${currentSortColumn}"]`);
        currentHeader.classList.add(`sort-${currentSortDirection}`);
    }
}



function updateEmployee(empId, field, value) {
    // Handle teams field specially - convert comma-separated string to array
    if (field === 'teams') {
        value = value.split(',').map(team => team.trim()).filter(team => team);
    }

    fetch('/employees/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: empId,
            field: field,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            allEmployees[empId][field] = value;
            showToast('Employee updated successfully', 'success');
        } else {
            showToast('Error updating employee', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating employee', 'error');
    });
}

function deleteEmployee(empId) {
    if (confirm('Are you sure you want to delete this employee?')) {
        const row = document.querySelector(`input[value*="${empId}"]`).closest('tr');
        row.remove();
        delete allEmployees[empId];
        showToast('Employee deleted successfully', 'success');
    }
}

function addEmployee() {
    const empId = document.getElementById('newEmpId').value.trim();
    const username = document.getElementById('newEmpUsername').value.trim();
    const email = document.getElementById('newEmpEmail').value.trim();
    const phone = document.getElementById('newEmpPhone').value.trim();
    const teams = document.getElementById('newEmpTeams').value.trim();

    if (!empId || !username) {
        showToast('Employee ID and Username are required', 'error');
        return;
    }

    const teamsArray = teams ? teams.split(',').map(team => team.trim()).filter(team => team) : [];

    // Add to local data
    allEmployees[empId] = {
        username: username,
        email: email,
        phone_extension: phone,
        teams: teamsArray
    };

    // Add to table
    const tbody = document.querySelector('#employeesTable tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${empId}</td>
        <td><input type="text" class="form-control form-control-sm" value="${username}" onchange="updateEmployee('${empId}', 'username', this.value)"></td>
        <td><input type="email" class="form-control form-control-sm" value="${email}" onchange="updateEmployee('${empId}', 'email', this.value)"></td>
        <td><input type="text" class="form-control form-control-sm" value="${phone}" onchange="updateEmployee('${empId}', 'phone_extension', this.value)"></td>
        <td><input type="text" class="form-control form-control-sm" value="${teams}" onchange="updateEmployee('${empId}', 'teams', this.value)"></td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('${empId}')"><i class="fas fa-trash"></i></button></td>
    `;
    tbody.appendChild(row);

    // Clear form
    document.getElementById('newEmpId').value = '';
    document.getElementById('newEmpUsername').value = '';
    document.getElementById('newEmpEmail').value = '';
    document.getElementById('newEmpPhone').value = '';
    document.getElementById('newEmpTeams').value = '';

    // Update team filter
    populateTeamFilter();

    showToast('Employee added successfully', 'success');
}

function refreshEmployees() {
    showToast('Refreshing employees from CRM...', 'info');
    setTimeout(() => {
        showToast('Employees refreshed successfully', 'success');
    }, 1000);
}

function exportEmployees() {
    const dataStr = JSON.stringify(allEmployees, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

    const exportFileDefaultName = 'employees_export.json';

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();

    showToast('Employees exported successfully', 'success');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
